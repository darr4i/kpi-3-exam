# Обробка помилок у PHP

Розглянемо різні категорії помилок (синтаксичні/фатальні, «м’які», операційні, доменні), використання Throwable/Exception, формування кодів помилок для REST API, логування через Monolog, виведення стек-трейсу та формування JSON-відповідей помилок.

## Категорії помилок

1. Код помилки (синтаксичні/фатальні) – помилки на рівні PHP-двигуна (наприклад, некоректний синтаксис, виклик неіснуючої функції). У PHP 7+ більшість фатальних помилок перетворилися на об’єкти класу Error, які можна ловити через catch (Error $e) або загальніший catch (Throwable $e).

2. «М’які» помилки (logical, non-exception) – ситуації, коли щось некоректно з даними чи бізнес-логікою, але продовження роботи можливе. Наприклад, невірний формат вхідних даних або незначні системні попередження. Такі помилки можна обробити без кидання виключень: наприклад, за допомогою trigger_error() для генерування попереджень, або повертати коди/булеві значення з методів (false/null) та логувати їх. Наприклад:

```
function getUserAge(array $userData) {
    if (empty($userData['age'])) {
        // М’яка помилка: просто логіруємо і повертаємо null
        trigger_error("Відсутній параметр age", E_USER_WARNING);
        return null;
    }
    return (int)$userData['age'];
}
```

3. Операційні помилки – помилки на рівні ресурсів/з’єднань: невдале підключення до БД, помилка мережі, збій читання файлу тощо. У коді такі помилки зазвичай кидають виключення (наприклад, PDOException при проблемах з БД). Їх слід ловити окремо або через загальний обробник. Приклад:

```
try {
    $pdo = new PDO($dsn, $user, $pass, $options);
    $stmt = $pdo->query("SELECT * FROM table");
} catch (PDOException $e) {
    // Операційна помилка: не можемо отримати дані з БД
    throw new RuntimeException("Не вдалось отримати дані з бази: " . $e->getMessage(), 0, $e);
}
```

4. Доменні помилки (custom domain) – помилки, що пов’язані з бізнес-правилами. Наприклад, «недостатньо коштів», або «об’єкт із такою дією не може бути видалений». Для них зазвичай створюють власні класи виключень. Наприклад, клас InsufficientFundsException для ситуації, коли в акаунті недостатньо коштів:

```
namespace App\Exceptions;

class InsufficientFundsException extends \RuntimeException {
    protected $code = 1001; // власний код помилки
}
```

і використаємо таке виключення:

```
function withdraw($amount) {
    $balance = 50;
    if ($amount > $balance) {
        throw new \App\Exceptions\InsufficientFundsException("Недостатньо коштів для зняття.");
    }
    // ... виконати зняття
}
```
