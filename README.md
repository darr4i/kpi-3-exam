# Обробка помилок у PHP

Розглянемо різні категорії помилок (синтаксичні/фатальні, «м’які», операційні, доменні), використання Throwable/Exception, формування кодів помилок для REST API, логування через Monolog, виведення стек-трейсу.

## Категорії помилок

1. Код помилки (синтаксичні/фатальні) – помилки на рівні PHP-двигуна (наприклад, некоректний синтаксис, виклик неіснуючої функції). У PHP 7+ більшість фатальних помилок перетворилися на об’єкти класу Error, які можна ловити через catch (Error $e) або загальніший catch (Throwable $e).

2. «М’які» помилки (logical, non-exception) – ситуації, коли щось некоректно з даними чи бізнес-логікою, але продовження роботи можливе. Наприклад, невірний формат вхідних даних або незначні системні попередження. Такі помилки можна обробити без кидання виключень: наприклад, за допомогою trigger_error() для генерування попереджень, або повертати коди/булеві значення з методів (false/null) та логувати їх. Наприклад:

```
function getUserAge(array $userData) {
    if (empty($userData['age'])) {
        // М’яка помилка: просто логіруємо і повертаємо null
        trigger_error("Відсутній параметр age", E_USER_WARNING);
        return null;
    }
    return (int)$userData['age'];
}
```

3. Операційні помилки – помилки на рівні ресурсів/з’єднань: невдале підключення до БД, помилка мережі, збій читання файлу тощо. У коді такі помилки зазвичай кидають виключення (наприклад, PDOException при проблемах з БД). Їх слід ловити окремо або через загальний обробник. Приклад:

```
try {
    $pdo = new PDO($dsn, $user, $pass, $options);
    $stmt = $pdo->query("SELECT * FROM table");
} catch (PDOException $e) {
    // Операційна помилка: не можемо отримати дані з БД
    throw new RuntimeException("Не вдалось отримати дані з бази: " . $e->getMessage(), 0, $e);
}
```

4. Доменні помилки (custom domain) – помилки, що пов’язані з бізнес-правилами. Наприклад, «недостатньо коштів», або «об’єкт із такою дією не може бути видалений». Для них зазвичай створюють власні класи виключень. Наприклад, клас InsufficientFundsException для ситуації, коли в акаунті недостатньо коштів:

```
namespace App\Exceptions;

class InsufficientFundsException extends \RuntimeException {
    protected $code = 1001; // власний код помилки
}
```

і використаємо таке виключення:

```
function withdraw($amount) {
    $balance = 50;
    if ($amount > $balance) {
        throw new \App\Exceptions\InsufficientFundsException("Недостатньо коштів для зняття.");
    }
    // ... виконати зняття
}
```

## Використання Throwable/Exception і типізація помилок

У PHP 7+ інтерфейс Throwable – базовий для усіх викидуваних об’єктів (Error та Exception реалізують його). Це означає, що конструкція catch (Throwable $t) спрацьовує і на помилки, і на виключення одночасно. Приклад:

```
try {
    someUndefinedFunction(); // викликає Error
} catch (\Throwable $e) {
    // зловить і Error, і Exception
    echo "Лове Throwable: " . $e->getMessage();
}
```

1. Перетворення помилок у виключення: використовується set_error_handler() для переводу вбудованих попереджень/повідомлень у виключення (клас ErrorException).

2. Глобальний обробник виключень: за допомогою set_exception_handler() можна задати функцію, яка зловить усі невиловлені виключення. Це корисно для логування і повернення юзер-френдлі відповіді.

## Формування кодів помилок для API

При розробці REST API важливо повертати змістовні HTTP-статуси і уніфіковані JSON-відповіді. Типові практики:

1. Відповідь повинна мати Content-Type: application/json та відповідний статус HTTP. Наприклад, 400–422 для помилок клієнта, 401 для аутентифікації, 404 для не знайденого ресурсу, 500 для внутрішніх помилок сервера тощо.

2. Використання єдиної структури JSON для помилок.

3. Власні коди помилок: крім HTTP-статусу, іноді додають внутрішній код помилки (app-code). Наприклад, у виключенні InsufficientFundsException можна встановити властивість code = 1001. У JSON відповідь слід включати як (HTTP-статус + code). Наприклад:

```
} catch (InsufficientFundsException $e) {
    http_response_code(402);
    echo json_encode([
        'status' => 'error',
        'error_code' => $e->getCode(),      // 1001
        'message' => $e->getMessage()
    ]);
}
```

## Логування помилок (Monolog)

1. Для відлагодження та моніторингу потрібно записувати помилки в логи. Рекомендується використовувати бібліотеки, наприклад Monolog, щоб централізовано керувати записом. Приклад логування помилки:

```
try {
    // Якесь виконання з можливим викидом помилки
} catch (\Throwable $e) {
    // Логувати повідомлення та стек-трейс
    $logger->error("Виникла помилка: " . $e->getMessage(), [
        'exception' => $e
    ]);
    // Відповідь API:
    http_response_code(500);
    echo json_encode([
        'status' => 'error',
        'message' => 'Внутрішня помилка сервера'
    ]);
}
```

## Стек-трейс помилки

У відповідь API (за потреби у режимі розробки) можна включати стек-трейс для дебагу. У виробництві ж краще надсилати лише узагальнену інформацію, а повний трасер відправляти в закриті логи. Рекомендується у логах фіксувати повідомлення помилки, стек-трейс, мітку часу тощо.

## Автор
Рабійчук Дар'я, група ІМ-21

